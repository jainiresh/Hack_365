# TOPIC
Pentesting Docker Registry

# OVERVIEW

# WHAT IS A DOCKER ?
Docker is a computer program , that performs virtualization on the level of Operating System.
- Also known as "conatinerization"

## DOCKER REGISTRY
- The docker Registry is an application that is stored in the server side.
- It is stateless
- Helps to distribute the docker.
- Note that both the docker versions are not authenticated by default

# DISCOVERY

1)  It is a HTTP running service.
- Easiest way to detect the service is by nMAP, but if it is running behind HTTP proxies Nmap won't detect it.

2) Fingerprints :
 - accessing "/" and nothing in response
 - accessing "/v2" and {} is required
 - accessing "/v2/_catalog" and may obtain => 
```
{"repositories":["alpine","ubuntu"]}
	{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"registry","Class":"","Name":"catalog","Action":"*"}]}]}
```
3) Always scan TCP port 5000 (common for docker)

4) Extract image from private docker registry using blobs and manifests and using its SHA value
```
Pulling image manifest - GET /v2/alpine/manifests/latest. Upon successful response you will get blobsum values in the response as follows:
{
   "name": <name>,
   "tag": <tag>,
   "fsLayers": [
      {
         "blobSum": SHA256:1d4c65f8151f9bcf5d44b3745570c1b8d75f768b7f543c1da20f87b4e5180eec
      },
      ...
    ]
   ],
   "history": <v1 images>,
   "signature": <JWS>
}
```
Get the SHA256 value including SHA256 and create another request.

5) Pulling a layer - GET /v2/alpine/blobs/SHA256:1d4c65f8151f9bcf5d44b3745570c1b8d75f768b7f543c1da20f87b4e5180eec
If you are using curl, then you can successfully download the tar file. For a single manifest, download all tar files using all the blobsum values in the single manifest.

Extract and find useful info/secrets/other private items.

6) If you can access GET /v2/<name>/tags/list then try bruteforcing <name> and see what all resources of docker registry you can access. Visit the https://docs.docker.com/registry/spec/api/ URL for more resources to list and bruteforce.

# SECURITY ISSUES

## Improper Authentication/Authorization Checks
This Docker Registry API is accessible without authentication.
A properly secured registry should return 401 when the "/v2/" endpoint is hit without credentials.
The response should include a WWW-Authenticate challenge, providing guidance on how to authenticate, such as with basic auth or a token service.

## Shodan Dorks
Docker Private Registries
"Docker-Distribution-Api-Version: registry" "200 OK" -gitlab

```
https://www.shodan.io/search?query=%22Docker-Distribution-Api-Version%3A+registry%22+%22200+OK%22+-gitlab
```

## INTERSTING ATTACKS
https://book.hacktricks.xyz/pentesting/5000-pentesting-docker-registry

# REFERENCES

a. https://www.acunetix.com/vulnerabilities/web/docker-registry-api-is-accessible-without-authentication/
b. https://hackerone.com/reports/924487
c. https://blog.dixitaditya.com/exploiting-docker-registry/
d. https://notsosecure.com/anatomy-of-a-hack-docker-registry/
e. https://github.com/lothos612/shodan
f. https://docs.docker.com/registry/spec/api/
